<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>RTD Boardings & Change Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    html, body, #map { width:100%; height:100vh; margin:0; padding:0; }
    #controls, #presets {
      position: absolute;
      background: rgba(255,255,255,0.9);
      padding: 8px; border:1px solid #ccc;
      font-family: sans-serif; font-size:13px;
      z-index:1000; display:flex; gap:12px;
      flex-wrap:wrap; align-items:center;
    }
    #controls { bottom:10px; left:50%; transform:translateX(-50%); }
    #presets {
      top:50%; right:10px;
      flex-direction:column; transform:translateY(-50%);
    }
    #presets button {
      margin-bottom:8px; padding:6px 12px; cursor:pointer;
    }
    #controls label {
      display:flex; flex-direction:column; align-items:center;
    }
    #controls input[type=range]{ width:80px; }
    #controls input[type=number]{ width:50px; margin-top:4px; }
    #controls select{ margin-top:4px; }
    #controls button{ padding:4px 8px; }
    #legend {
      display:flex; align-items:center; gap:8px; font-size:12px;
    }
    #legend span {
      display:inline-block; width:12px; height:12px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Presets -->
  <div id="presets">
    <button id="presetBoard">Boardings Preset</button>
    <button id="presetChange">Change Preset</button>
  </div>

  <!-- Controls -->
  <div id="controls">
    <button id="playBtn">▶ Play</button>
    <input type="range" id="timeline" min="0" max="0" step="1" value="0"/>

    <label>Schedule
      <select id="scheduleSelect"></select>
    </label>

    <label>Map Type
      <select id="mapType">
        <option value="boardings" selected>Boardings</option>
        <option value="change">Change</option>
      </select>
    </label>

    <label>Radius
      <input type="range" id="radius" min="1" max="20" step="1" value="10"/>
      <input type="number" id="radiusNum" min="1" max="20" step="1" value="10"/>
    </label>

    <label>Blur
      <input type="range" id="blur" min="1" max="20" step="1" value="8"/>
      <input type="number" id="blurNum" min="1" max="20" step="1" value="8"/>
    </label>

    <label>Max
      <input type="range" id="max" min="0" max="5" step="0.1" value="0.5"/>
      <input type="number" id="maxNum" min="0" max="5" step="0.1" value="0.5"/>
    </label>

    <label>Scale
      <select id="scaleType">
        <option value="normal">Normal</option>
        <option value="sqrt" selected>√ Scale</option>
        <option value="log">Log₁₀</option>
      </select>
    </label>

    <div id="legend">
      <span style="background:red"></span> Increase
      <span style="background:blue"></span> Decrease
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script>
    const schedules = [
      'Jan18','May18','Aug18','Jan19','May19','Aug19',
      'Jan20','May20','Aug20','Jan21','May21','Aug21',
      'Jan22','May22','Aug22','Jan23','May23','Aug23',
      'Jan24','May24','Sep24'
    ];

    // Initialize map
    const map = L.map('map').setView([39.75,-105.0],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'© OpenStreetMap'
    }).addTo(map);

    // Controls
    const playBtn      = document.getElementById('playBtn');
    const timeline     = document.getElementById('timeline');
    const scheduleSel  = document.getElementById('scheduleSelect');
    const mapTypeSel   = document.getElementById('mapType');
    const radiusRng    = document.getElementById('radius');
    const blurRng      = document.getElementById('blur');
    const maxRng       = document.getElementById('max');
    const radiusNum    = document.getElementById('radiusNum');
    const blurNum      = document.getElementById('blurNum');
    const maxNum       = document.getElementById('maxNum');
    const scaleSel     = document.getElementById('scaleType');
    const legend       = document.getElementById('legend');
    const presetBoard  = document.getElementById('presetBoard');
    const presetChange = document.getElementById('presetChange');

    let allFeatures = [], heatLayer, posLayer, negLayer;
    let playing = false, playInterval;

    // Preload data
    Promise.all(
      schedules.map(key =>
        fetch(`sanitized_output/rtd_${key}_Weekday.geojson`)
          .then(r => r.ok? r.json() : Promise.reject(key))
          .then(gj => gj.features)
          .catch(e => { console.error('Missing',e); return []; })
      )
    ).then(arrays => {
      allFeatures = arrays;
      timeline.max = schedules.length - 1;
      scheduleSel.innerHTML = schedules.map(s=>`<option>${s}</option>`).join('');
      updateFrame(0);
    });

    // Frame control
    function updateFrame(i){
      i = Math.max(0, Math.min(schedules.length-1, i));
      timeline.value    = i;
      scheduleSel.value = schedules[i];
      renderFrame(i);
    }
    playBtn.onclick = ()=>{
      if(!playing){
        playing = true; playBtn.textContent='❚❚ Pause';
        playInterval = setInterval(()=>updateFrame(+timeline.value+1),1000);
      } else {
        playing = false; playBtn.textContent='▶ Play'; clearInterval(playInterval);
      }
    };
    timeline.oninput     = ()=>updateFrame(+timeline.value);
    scheduleSel.onchange = ()=>updateFrame(schedules.indexOf(scheduleSel.value));

    // Build heat points
    function computePoints(feats, isDelta, positive){
      const scale = scaleSel.value;
      return feats.reduce((pts,f)=>{
        const v = isDelta? f.properties.delta : f.properties.total_rides;
        if(isDelta){
          if(positive && v<=0) return pts;
          if(!positive && v>=0) return pts;
        }
        let w = Math.abs(v);
        if(scale==='sqrt') w = Math.sqrt(w);
        if(scale==='log')  w = Math.log10(w+1);
        pts.push([f.geometry.coordinates[1], f.geometry.coordinates[0], w]);
        return pts;
      },[]);
    }

    // Render one frame
    function renderFrame(idx){
      [heatLayer,posLayer,negLayer].forEach(l=>l&&map.removeLayer(l));
      const feats = allFeatures[idx];
      const rad = +radiusNum.value, blu = +blurNum.value, mx = +maxNum.value;

      if(mapTypeSel.value==='boardings'){
        // Boardings uses √ default
        heatLayer = L.heatLayer(
          computePoints(feats,false),
          {radius:rad, blur:blu, max:mx}
        ).addTo(map);
        legend.innerHTML = '<span style="background:red"></span> Boardings';

      } else {
        // When changing to Delta, ensure scale is Normal
        heatLayer = null; posLayer = null; negLayer = null;
        // Override: if user hasn't switched scale yet, set to Normal
        if(scaleSel.value !== 'normal'){
          scaleSel.value = 'normal';
        }
        // Render delta
        posLayer = L.heatLayer(
          computePoints(feats,true,true),
          {radius:rad, blur:blu, max:mx, gradient:{0.4:'pink',1:'red'}}
        ).addTo(map);
        negLayer = L.heatLayer(
          computePoints(feats,true,false),
          {radius:rad, blur:blu, max:mx, gradient:{0.4:'lightblue',1:'blue'}}
        ).addTo(map);
        legend.innerHTML = '<span style="background:red"></span> Increase  '+
                           '<span style="background:blue"></span> Decrease';
      }
    }

    // Wire sliders ↔ number inputs
    function bind(rng,num){
      rng.oninput  = ()=>{ num.value=rng.value; renderFrame(+timeline.value); };
      num.onchange = ()=>{ rng.value=num.value; renderFrame(+timeline.value); };
    }
    bind(radiusRng,radiusNum);
    bind(blurRng,  blurNum);
    bind(maxRng,   maxNum);

    // Ensure scale dropdown follows mapType
    mapTypeSel.onchange = ()=>{
      if(mapTypeSel.value==='change'){
        scaleSel.value = 'normal';
      } else {
        scaleSel.value = 'sqrt';
      }
      renderFrame(+timeline.value);
    };
    scaleSel.onchange = ()=> renderFrame(+timeline.value);

    // Presets
    presetBoard.onclick = ()=>{
      scaleSel.value    = 'sqrt';
      radiusRng.value   = radiusNum.value = 25;
      blurRng.value     = blurNum.value   = 15;
      maxRng.value      = maxNum.value    = 10.3;
      renderFrame(+timeline.value);
    };
    presetChange.onclick = ()=>{
      scaleSel.value    = 'normal';
      radiusRng.value   = radiusNum.value = 10;
      blurRng.value     = blurNum.value   = 8;
      maxRng.value      = maxNum.value    = 0.5;
      renderFrame(+timeline.value);
    };
  </script>
</body>
</html>