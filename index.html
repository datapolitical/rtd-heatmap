<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>RTD Boardings & Change Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    html, body, #map { width:100%; height:100vh; margin:0; padding:0; }
    #controls, #presets {
      position:absolute; background:rgba(255,255,255,0.9);
      padding:8px; border:1px solid #ccc;
      font-family:sans-serif; font-size:13px;
      z-index:1000; display:flex; gap:12px;
      flex-wrap:wrap; align-items:center;
    }
    #controls { bottom:10px; left:50%; transform:translateX(-50%); }
    #presets { top:50%; right:10px; flex-direction:column; transform:translateY(-50%); }
    #presets button, #presets select { margin-bottom:8px; padding:6px 12px; cursor:pointer; }
    #controls label { display:flex; flex-direction:column; align-items:center; }
    #controls input[type=range]{ width:80px; }
    #controls input[type=number]{ width:50px; margin-top:4px; }
    #controls select{ margin-top:4px; }
    #controls button{ padding:4px 8px; }
    #legend { display:flex; align-items:center; gap:8px; font-size:12px; }
    #legend span { display:inline-block; width:12px; height:12px; }
    .no-data { font-weight:bold; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Presets -->
  <div id="presets">
    <button id="defaultBtn">Default</button>
    <select id="presetSelect">
      <option value="" disabled selected>Choose Preset</option>
      <option value="b90">Boardings Top 10%</option>
      <option value="b75">Boardings Top 25%</option>
      <option value="b50">Boardings Median</option>
      <option value="b25">Boardings Bottom 25%</option>
      <option value="b10">Boardings Extreme Hubs</option>
      <option value="c90">Change Top 10%</option>
      <option value="c75">Change Top 25%</option>
      <option value="c50">Change Median</option>
      <option value="c25">Change Bottom 25%</option>
      <option value="c10">Change Stable</option>
    </select>
  </div>

  <!-- Controls -->
  <div id="controls">
    <button id="playBtn">▶ Play</button>
    <input type="range" id="timeline" min="0" max="0" step="1" value="0"/>

    <label>Schedule
      <select id="scheduleSelect"></select>
    </label>

    <label>Map Type
      <select id="mapType">
        <option value="boardings" selected>Boardings</option>
        <option value="change">Change</option>
      </select>
    </label>

    <label>Radius
      <input type="range" id="radius" min="1" max="20" step="1" value="10"/>
      <input type="number" id="radiusNum" min="1" max="20" step="1" value="10"/>
    </label>

    <label>Blur
      <input type="range" id="blur" min="1" max="20" step="1" value="8"/>
      <input type="number" id="blurNum" min="1" max="20" step="1" value="8"/>
    </label>

    <label>Max
      <input type="range" id="max" min="0" max="20" step="0.1" value="0.5"/>
      <input type="number" id="maxNum" min="0" max="20" step="0.1" value="0.5"/>
    </label>

    <label>Scale
      <select id="scaleType">
        <option value="normal">Normal</option>
        <option value="sqrt" selected>√ Scale</option>
        <option value="log">Log₁₀</option>
      </select>
    </label>

    <div id="legend">
      <span style="background:red"></span> Increase
      <span style="background:blue"></span> Decrease
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script>
    const map = L.map('map').setView([39.75,-105.0],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'© OpenStreetMap'
    }).addTo(map);

    // UI refs
    const playBtn      = document.getElementById('playBtn'),
          timeline     = document.getElementById('timeline'),
          scheduleSel  = document.getElementById('scheduleSelect'),
          mapTypeSel   = document.getElementById('mapType'),
          radiusRng    = document.getElementById('radius'),
          blurRng      = document.getElementById('blur'),
          maxRng       = document.getElementById('max'),
          radiusNum    = document.getElementById('radiusNum'),
          blurNum      = document.getElementById('blurNum'),
          maxNum       = document.getElementById('maxNum'),
          scaleSel     = document.getElementById('scaleType'),
          legend       = document.getElementById('legend'),
          defaultBtn   = document.getElementById('defaultBtn'),
          presetSelect = document.getElementById('presetSelect');

    let schedules = [], allFeatures = [], heatLayer, posLayer, negLayer;
    let playing = false, playInterval, noDataControl = null;

    // 1) Discover which files actually exist
    fetch('sanitized_output/')
      .then(r => r.text())
      .then(html => {
        // parse directory listing for geojson links
        const parser = new DOMParser();
        const doc = parser.parseFromString(html,'text/html');
        schedules = Array.from(doc.querySelectorAll('a'))
          .map(a=>a.getAttribute('href'))
          .filter(h=>h.endsWith('_Weekday.geojson'))
          .map(fn=>fn.match(/^rtd_(.+)_Weekday/)[1])
          .sort((a,b)=> new Date(a) - new Date(b)); // fallback sort
        // populate UI
        scheduleSel.innerHTML = schedules.map(s=>`<option>${s}</option>`).join('');
        timeline.max = schedules.length - 1;
        // preload only the existing files
        return Promise.all(
          schedules.map(key=>
            fetch(`sanitized_output/rtd_${key}_Weekday.geojson`)
              .then(r=>r.json())
              .then(gj=>gj.features)
          )
        );
      })
      .then(arrays=>{
        allFeatures = arrays;
        updateFrame(0);
      })
      .catch(err=>console.error('Loading schedule list failed:',err));

    // 2) Frame & play controls
    function updateFrame(i){
      i = Math.min(Math.max(0,i),schedules.length-1);
      timeline.value    = i;
      scheduleSel.value = schedules[i];
      renderFrame(i);
    }
    playBtn.onclick = ()=>{
      if(!playing){
        playing = true; playBtn.textContent='❚❚ Pause';
        playInterval = setInterval(()=>updateFrame(+timeline.value+1),1000);
      } else {
        playing = false; playBtn.textContent='▶ Play'; clearInterval(playInterval);
      }
    };
    timeline.oninput     = ()=>updateFrame(+timeline.value);
    scheduleSel.onchange = ()=>updateFrame(schedules.indexOf(scheduleSel.value));

    // 3) Rendering, with "no data" overlay
    function renderFrame(idx){
      [heatLayer,posLayer,negLayer].forEach(l=>l&&map.removeLayer(l));
      if(noDataControl){ map.removeControl(noDataControl); noDataControl=null; }
      const feats = allFeatures[idx];
      if(!feats || feats.length===0){
        noDataControl = L.control({position:'topright'});
        noDataControl.onAdd = ()=>{
          const div = L.DomUtil.create('div','no-data');
          div.style.background='rgba(255,255,255,0.8)';
          div.style.padding='4px 8px';
          div.style.border='1px solid #777';
          div.textContent = `No data for ${schedules[idx]}`;
          return div;
        };
        noDataControl.addTo(map);
        return;
      }
      const rad = +radiusNum.value, blu = +blurNum.value, mx = +maxNum.value;
      if(mapTypeSel.value==='boardings'){
        heatLayer = L.heatLayer(
          computePoints(feats,false),
          {radius:rad,blur:blu,max:mx}
        ).addTo(map);
        legend.innerHTML = '<span style="background:red"></span> Boardings';
      } else {
        if(scaleSel.value!=='normal') scaleSel.value='normal';
        posLayer = L.heatLayer(
          computePoints(feats,true,true),
          {radius:rad,blur:blu,max:mx,gradient:{0.4:'pink',1:'red'}}
        ).addTo(map);
        negLayer = L.heatLayer(
          computePoints(feats,true,false),
          {radius:rad,blur:blu,max:mx,gradient:{0.4:'lightblue',1:'blue'}}
        ).addTo(map);
        legend.innerHTML = '<span style="background:red"></span> Increase  '+
                           '<span style="background:blue"></span> Decrease';
      }
    }

    // 4) Heatmap data builder
    function computePoints(feats,isDelta,positive){
      const scale = scaleSel.value;
      return feats.reduce((pts,f)=>{
        const v = isDelta?f.properties.delta:f.properties.total_rides;
        if(isDelta){
          if(positive&&v<=0) return pts;
          if(!positive&&v>=0) return pts;
        }
        let w = Math.abs(v);
        if(scale==='sqrt') w=Math.sqrt(w);
        if(scale==='log')  w=Math.log10(w+1);
        pts.push([f.geometry.coordinates[1],f.geometry.coordinates[0],w]);
        return pts;
      },[]);
    }

    // 5) Bind sliders ↔ numbers
    function bind(rng,num){
      rng.oninput  = ()=>{ num.value=rng.value; renderFrame(+timeline.value); };
      num.onchange = ()=>{ rng.value=num.value; renderFrame(+timeline.value); };
    }
    bind(radiusRng,radiusNum);
    bind(blurRng,  blurNum);
    bind(maxRng,   maxNum);
    mapTypeSel.onchange = ()=>renderFrame(+timeline.value);
    scaleSel.onchange   = ()=>renderFrame(+timeline.value);

    // 6) Default reset
    defaultBtn.onclick = ()=>{
      radiusRng.value   = radiusNum.value = 10;
      blurRng.value     = blurNum.value   = 8;
      maxRng.value      = maxNum.value    = 0.5;
      scaleSel.value    = mapTypeSel.value==='boardings' ? 'sqrt' : 'normal';
      presetSelect.selectedIndex = 0;
      renderFrame(+timeline.value);
    };

    // 7) Preset dropdown (10 data‐driven views)
    presetSelect.onchange = ()=>{
      const val = presetSelect.value, idx = +timeline.value, feats = allFeatures[idx];
      let arr, pct, rad, blu, scale;
      if(val.startsWith('b')){
        // Boardings
        if(val==='b90'){ pct=0.90; rad=20; blu=15; scale='sqrt'; arr=feats.map(f=>Math.sqrt(f.properties.total_rides)); }
        else if(val==='b75'){ pct=0.75; rad=18; blu=12; scale='sqrt'; arr=feats.map(f=>Math.sqrt(f.properties.total_rides)); }
        else if(val==='b50'){ pct=0.50; rad=15; blu=10; scale='sqrt'; arr=feats.map(f=>Math.sqrt(f.properties.total_rides)); }
        else if(val==='b25'){ pct=0.25; rad=12; blu=8;  scale='sqrt'; arr=feats.map(f=>Math.sqrt(f.properties.total_rides)); }
        else /*b10*/        { pct=0.99; rad=25; blu=20; scale='log';  arr=feats.map(f=>Math.log10(f.properties.total_rides+1)); }
      } else {
        // Change
        if(val==='c90'){ pct=0.90; rad=15; blu=12; scale='normal'; arr=feats.map(f=>Math.abs(f.properties.delta)); }
        else if(val==='c75'){ pct=0.75; rad=12; blu=10; scale='normal'; arr=feats.map(f=>Math.abs(f.properties.delta)); }
        else if(val==='c50'){ pct=0.50; rad=10; blu=8;  scale='normal'; arr=feats.map(f=>Math.abs(f.properties.delta)); }
        else if(val==='c25'){ pct=0.25; rad=8;  blu=6;  scale='normal'; arr=feats.map(f=>Math.abs(f.properties.delta)); }
        else /*c10*/        { pct=0.10; rad=6;  blu=4;  scale='normal'; arr=feats.map(f=>Math.abs(f.properties.delta)); }
      }
      arr.sort((a,b)=>a-b);
      const maxVal = arr[Math.floor(arr.length * pct)] || 0.1;

      radiusRng.value   = radiusNum.value = rad;
      blurRng.value     = blurNum.value   = blu;
      maxRng.value      = maxNum.value    = maxVal.toFixed(1);
      scaleSel.value    = scale;
      renderFrame(idx);
    };
  </script>
</body>
</html>